<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Region API Chain Tool (with Auth)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center py-12 px-4 text-slate-800">

    <div class="max-w-3xl w-full bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        <!-- 헤더 영역 -->
        <div class="bg-slate-900 p-8 text-white">
            <h1 class="text-3xl font-extrabold mb-2 tracking-tight">API 연쇄 호출 시스템</h1>
            <p class="text-slate-400 text-sm font-medium uppercase tracking-wider">환경/권역/브랜드별 자동 인증 및 서버 요청 도구</p>
        </div>

        <!-- 설정 영역 -->
        <div class="p-6 bg-slate-100 border-b border-slate-200">
            <h2 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">Server Configurations & Security</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 환경 -->
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1 ml-1">환경 (Environment)</label>
                    <select id="envSelect" class="w-full bg-white border border-slate-300 text-sm rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer">
                        <option value="STG">STG (Staging)</option>
                        <option value="PRD">PRD (Production)</option>
                    </select>
                </div>
                <!-- 권역 -->
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1 ml-1">권역 (Region)</label>
                    <select id="regionSelect" class="w-full bg-white border border-slate-300 text-sm rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer">
                        <option value="KR">KR (Korea)</option>
                        <option value="EU">EU (Europe)</option>
                        <option value="NA">NA (North America)</option>
                        <option value="SA">SA (South America)</option>
                    </select>
                </div>
                <!-- 브랜드 -->
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1 ml-1">브랜드 (Brand)</label>
                    <select id="brandSelect" class="w-full bg-white border border-slate-300 text-sm rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition-all cursor-pointer">
                        <option value="A">Brand A</option>
                        <option value="B">Brand B</option>
                        <option value="C">Brand C</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 실행 영역 -->
        <div class="p-8">
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <div class="flex-1">
                    <label for="emailInput" class="block text-sm font-bold text-slate-700 mb-2">대상 이메일 주소</label>
                    <input type="email" id="emailInput" 
                        class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition-all text-lg"
                        placeholder="이메일을 입력하세요..."
                        value="Sincere@april.biz">
                </div>
                <div class="flex items-end">
                    <button id="executeBtn" 
                        class="w-full md:w-auto px-10 py-3.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                        인증 후 호출 시작
                    </button>
                </div>
            </div>

            <!-- 현재 타겟 정보 정보 -->
            <div id="targetInfo" class="mb-6 px-4 py-3 bg-slate-900 border border-slate-800 rounded-lg text-[11px] font-mono text-slate-300 leading-relaxed">
                <div><span class="text-blue-400">Target Server:</span> <span id="displayUrl" class="text-white">...</span></div>
                <div><span class="text-blue-400">Header serverKey:</span> <span id="displayKey" class="text-white">...</span></div>
                <div><span class="text-blue-400">Header Auth:</span> <span id="displayAuth" class="text-slate-500">Basic *********</span></div>
            </div>

            <!-- 결과 대시보드 -->
            <div class="space-y-4">
                <!-- 단계 1 -->
                <div id="step1" class="p-5 bg-white rounded-xl border border-slate-200 shadow-sm opacity-40 transition-all duration-500">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 flex items-center justify-center bg-slate-900 text-white rounded-lg text-xs font-bold">01</span>
                            <h3 class="font-bold text-slate-800">User Identification</h3>
                        </div>
                        <div id="step1Status"></div>
                    </div>
                    <div id="step1Content" class="text-xs text-slate-600 font-mono bg-slate-50 p-4 rounded-lg border border-slate-100 hidden overflow-x-auto whitespace-pre">
                    </div>
                </div>

                <!-- 단계 2 -->
                <div id="step2" class="p-5 bg-white rounded-xl border border-slate-200 shadow-sm opacity-40 transition-all duration-500">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 flex items-center justify-center bg-slate-900 text-white rounded-lg text-xs font-bold">02</span>
                            <h3 class="font-bold text-slate-800">Fetch Detailed Resources</h3>
                        </div>
                        <div id="step2Status"></div>
                    </div>
                    <div id="step2Content" class="text-xs text-slate-600 font-mono bg-slate-50 p-4 rounded-lg border border-slate-100 hidden overflow-x-auto whitespace-pre">
                    </div>
                </div>
            </div>

            <!-- 하단 메시지 -->
            <div id="messageBox" class="mt-8 hidden p-4 rounded-xl text-center text-sm font-bold animate-bounce"></div>
        </div>
    </div>

    <script>
        const envSelect = document.getElementById('envSelect');
        const regionSelect = document.getElementById('regionSelect');
        const brandSelect = document.getElementById('brandSelect');
        
        const displayUrl = document.getElementById('displayUrl');
        const displayKey = document.getElementById('displayKey');
        const displayAuth = document.getElementById('displayAuth');
        
        const emailInput = document.getElementById('emailInput');
        const executeBtn = document.getElementById('executeBtn');
        const messageBox = document.getElementById('messageBox');

        /**
         * 환경/권역/브랜드별 고정 헤더 및 서버 정보 매핑
         * 실제 보안 정책에 따라 값을 수정하세요.
         */
        function getServerConfig() {
            const env = envSelect.value;
            const region = regionSelect.value;
            const brand = brandSelect.value;
            
            // 유니크 키 생성 (예: STG-KR-A)
            const configKey = `${env}-${region}-${brand}`;
            
            // 서버별 고정 데이터 (Mock)
            // 실제 환경에서는 이 객체에 실제 serverKey와 인증 정보를 매핑합니다.
            const configStorage = {
                'STG-KR-A': { sKey: 'SK_STG_KR_A_9921', user: 'admin_kr', pass: 'stg_pass_1' },
                'STG-KR-B': { sKey: 'SK_STG_KR_B_8832', user: 'user_kr_b', pass: 'stg_pass_2' },
                'PRD-KR-A': { sKey: 'SK_PRD_KR_A_1102', user: 'prd_oper_a', pass: 'prd_secure_a' },
                'PRD-EU-C': { sKey: 'SK_PRD_EU_C_7741', user: 'eu_manager', pass: 'eu_secret_c' },
                // ... 필요한 모든 조합을 추가
            };

            const data = configStorage[configKey] || { sKey: 'SK_DEFAULT_0000', user: 'guest', pass: 'guest' };
            const baseUrl = `https://${brand.toLowerCase()}.api-${region.toLowerCase()}.${env.toLowerCase()}.internal`;
            
            // Basic Auth 헤더 생성 (Base64 인코딩)
            const authHeader = 'Basic ' + btoa(`${data.user}:${data.pass}`);

            return {
                url: baseUrl,
                serverKey: data.sKey,
                authorization: authHeader
            };
        }

        function updateDisplayInfo() {
            const config = getServerConfig();
            displayUrl.textContent = config.url;
            displayKey.textContent = config.serverKey;
            displayAuth.textContent = `Basic ${config.authorization.split(' ')[1].substring(0, 8)}... (Encoded)`;
        }

        [envSelect, regionSelect, brandSelect].forEach(el => el.addEventListener('change', updateDisplayInfo));
        updateDisplayInfo();

        function updateUI(stepId, status, content = '') {
            const stepEl = document.getElementById(stepId);
            const statusEl = document.getElementById(stepId + 'Status');
            const contentEl = document.getElementById(stepId + 'Content');

            if (status === 'loading') {
                stepEl.classList.remove('opacity-40');
                stepEl.classList.add('border-blue-400', 'ring-4', 'ring-blue-50');
                statusEl.innerHTML = '<div class="loading-spinner"></div>';
            } else if (status === 'success') {
                stepEl.classList.remove('border-blue-400', 'ring-4', 'ring-blue-50');
                stepEl.classList.add('border-green-200');
                statusEl.innerHTML = '<span class="px-2 py-1 bg-green-100 text-green-600 text-[10px] font-black rounded uppercase">Success</span>';
                contentEl.classList.remove('hidden');
                contentEl.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            } else if (status === 'error') {
                stepEl.classList.remove('opacity-40', 'border-blue-400');
                stepEl.classList.add('border-red-200');
                statusEl.innerHTML = '<span class="px-2 py-1 bg-red-100 text-red-600 text-[10px] font-black rounded uppercase">Error</span>';
                contentEl.classList.remove('hidden');
                contentEl.textContent = content;
                contentEl.classList.add('text-red-500');
            }
        }

        async function startApiChain() {
            const email = emailInput.value.trim();
            if (!email) {
                alert('이메일을 입력해주세요.');
                return;
            }

            const config = getServerConfig();
            
            // 공통 헤더 설정
            const customHeaders = {
                'Content-Type': 'application/json',
                'serverKey': config.serverKey,
                'Authorization': config.authorization
            };
            
            // UI 초기화
            messageBox.classList.add('hidden');
            [1, 2].forEach(num => {
                const step = document.getElementById(`step${num}`);
                step.className = step.className.replace(/border-(blue|green|red)-\d+/, 'border-slate-200').replace('ring-4 ring-blue-50', '');
                step.classList.add('opacity-40');
                document.getElementById(`step${num}Content`).classList.add('hidden');
                document.getElementById(`step${num}Status`).innerHTML = '';
            });
            
            executeBtn.disabled = true;
            executeBtn.textContent = "Authenticating...";

            try {
                // --- STEP 1: Email로 ID 찾기 ---
                updateUI('step1', 'loading');
                
                // 실제 호출 시: await fetch(`${config.url}/users?email=${email}`, { headers: customHeaders });
                const response1 = await fetch(`https://jsonplaceholder.typicode.com/users?email=${email}`);
                if (!response1.ok) throw new Error(`API 1 호출 실패: ${response1.status}`);
                
                const data1 = await response1.json();
                if (!data1 || data1.length === 0) throw new Error('해당 이메일의 사용자를 찾을 수 없습니다.');

                const foundId = data1[0].id;
                updateUI('step1', 'success', {
                    request_headers: {
                        serverKey: customHeaders.serverKey,
                        Authorization: "Basic ****** (Hidden)"
                    },
                    extracted_id: foundId,
                    user_name: data1[0].name
                });

                // --- STEP 2: 추출한 ID로 상세 데이터 호출 ---
                updateUI('step2', 'loading');
                
                // 실제 호출 시: await fetch(`${config.url}/posts?userId=${foundId}`, { headers: customHeaders });
                const response2 = await fetch(`https://jsonplaceholder.typicode.com/posts?userId=${foundId}`);
                if (!response2.ok) throw new Error(`API 2 호출 실패: ${response2.status}`);
                
                const data2 = await response2.json();
                updateUI('step2', 'success', {
                    request_url: `${config.url}/posts?userId=${foundId}`,
                    item_count: data2.length,
                    posts: data2.slice(0, 2) // 상위 2개만 샘플 출력
                });

                messageBox.textContent = "인증 및 연쇄 호출이 성공적으로 완료되었습니다!";
                messageBox.className = "mt-8 p-4 rounded-xl text-center text-sm font-bold bg-green-50 text-green-700 border border-green-200 block animate-bounce";

            } catch (error) {
                console.error(error);
                const currentStep = document.getElementById('step1Status').innerHTML.includes('spinner') ? 'step1' : 'step2';
                updateUI(currentStep, 'error', error.message);
                
                messageBox.textContent = `작업 실패: ${error.message}`;
                messageBox.className = "mt-8 p-4 rounded-xl text-center text-sm font-bold bg-red-50 text-red-700 border border-red-200 block";
            } finally {
                executeBtn.disabled = false;
                executeBtn.textContent = "인증 후 호출 시작";
            }
        }

        executeBtn.addEventListener('click', startApiChain);
        emailInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') startApiChain(); });
    </script>
</body>
</html>